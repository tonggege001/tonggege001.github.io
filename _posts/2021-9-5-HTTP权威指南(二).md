---
layout: post  
title: 2021-9-4-HTTP权威指南阅读（二）
date: 2021-9-4
categories: blog
tags: [HTTP,技术]
description: 2021-8-4-HTTP权威指南阅读，记录一下关键的笔记内容。
---  

## 客户端识别与Cookie机制  
用户识别机制包括：  
* 承载用户身份信息的HTTP首部  
* 客户端IP地址跟踪，通过用户的IP地址对其进行识别  
* 用户登录，用认证的方式来识别用户  
* 胖URL，一种在URL中嵌入识别信息的技术  
* cookie，一种功能强大且高效的持久身份识别技术  

### HTTP 首部  
下表给出最常见的用来承载用户相关信息的HTTP请求首部。  
|首部名称|首部类型|描述|  
|:----:|:----:|:----:|
|From| 请求|用户的E-mail地址|
|User-Agent| 请求|用户的浏览器软件|
|Referer|请求|用户是从这个页面依照链接跳转过来的|
|Authorization|请求|用户名和密码|
|Client-IP|扩展(请求)|客户端的IP地址|
|X-Forward-For|扩展(请求)|客户端的IP地址|
|Cookie|扩展(请求)|服务器产生的ID标签|

### 客户端IP地址  
缺点：  
1. 描述的是机器而不是用户  
2. DHCP协议动态分配IP，导致用户每次都会得到一个新的IP  
3. NAT方法导致内部客户端的IP地址被转换，无法得到真实的IP
4. HTTP代理和网关会打开一些新的连接与服务器通信，此时看到的IP不是用户的IP，而是代理的IP  

### 用户登录  
浏览器先向URL发送请求，然后服务器返回401 Not Login，并添加WWW-Authentication 首部，要求用户登录，此时弹出登录框。用户输入账户和密码后，重复原来的请求，这次它会添加一个Authentication首部，说明用户名和密码，对其加密。服务器知道用户身份后，客户端在每次需要使用用户名和密码时都会自动存储下发送的值，作为表示。这样在整个会话期间维持用户身份。  

### 胖URL
有些Web站点会为每个用户生成特定版本的URL来追踪用户身份。通常会对真正的URL进行扩展，在URL路径开始或结束的地方添加一些状态信息，用户浏览时，Web服务器会动态生成一些超链接，继续维护URL中的状态信息，例如：  
```txt  
www.xxx.com/exec/obidos/229220/002-1145265-8016828/
```  
002-1145265-8016828就是用户特有的标志。用户首次访问Web站点时，会生成唯一一个ID，用服务器可以识别的方式将这个ID添加到URL中，然后服务器就会将客户端重新导向这个胖URL，不论什么时候，只要用户收到对胖URL的请求，就可以去查找与那个用户ID相关的所有增量状态，然后重写所有的输出超链，使其成为胖URL，以维护用户的ID。  

缺点：  
1. 丑陋的URL
2. 无法共享URL，把这个URL分享出去，可能就会存在信息泄露问题  
3. 破坏HTTP缓存，因为每个URL都不同了  
4. 额外的服务器负荷，因为需要重新HTML页面使 URL变胖
5. 逃逸口，用户跳转到其他网站或者请求一个特定的URL使，就很容易无意中逃离胖URL的会话。只有当用户严格地追随预先修改过的链接时，胖URL才能工作。如果用户逃离此链接，就会丢失他的进展。  
6. 在会话间是非持久的，除非用户收藏了特定的胖URL，否则用户退出登录时，所有的信息都会丢失  

### Cookie  
**cookie类型**  
cookie分为两类： 会话cookie和持久cookie。会话cookie是一种临时cookie，它记录了用户访问站点时的设置和偏好，用户退出浏览器时cookie就被删除看。持久cookie生存时间更长，它们存储在硬盘上，浏览器退出计算机重启时它们仍然存在，通常持久cookie维护某个用户会周期性访问的站点和配置文件或登录名。  

会话cookie和持久cookie唯一区别是它们的过期时间。如果设置Discard参数或者没有设置Expires或Max-Agec参数来扩展过期时间，这个cookie就是一个会话cookie。  

**cookie如何工作**  
cookie由name=value的列表组成，它通过web服务器响应中的Set-Cookie或Set-Cookie2首部将其贴到用户身上。  

cookie是一种客户端状态，存储在客户端上，例如网景的Navigator会将cookie存在cookies.txt的文本文件中，例如：  
```txt  
# domain        allh    path    secure  expires     name    value  
www.baidu.com   FALSE   /       FALSE   1123432123  cc      23424
```  

domain表示域，cookie作用的服务器URL。  
allh：是域中所有主机都获取cookie还是只有制定了名字的主机获取。  
path：是域中与cookie相关的路径前缀。  
secure：是否只有在使用SSL连接时才发送这个Cookie  
expires：过期时间的UNIX秒数（绝对时间）  
name：cookie变量的名字
value：cookie变量的值  

**不同站点使用不同cookie**  
产生cookie的服务器可以向Set-Cookie响应首部添加一个Domain属性来控制哪些站点可以看到那个cookie，比如  
```txt  
Set-Cookie: user="mary17"; domain="artist.com"
```  

cookie的路径属性：通过domain+path属性设置cookie的使用范围：  
```txt  
Set-Cookie: pref=compact; domain="artist.con"; path=/autos/
```  
客户端只有访问xxx.artist.com/autos/xxx/xxx时才会携带该cookie  

**cookies版本0**  
Set-Cookie属性：  
NAME=VALUE  
Expires: 可选的。这个属性会指定一个日期字符串，用来定义cookie的实际生存期。一旦到了过期时间，就不再存储或发布这个cookie了，日期格式：WeekDay, DD-Mon-YY HH:MM:SS GMT，例如：  
```txt  
Set-Cookie: foo=bar; expires=Wednesday, 09-Nov-99 23:12:40 GMT
```  
Domain: 可选的，浏览器只向指定域中的服务器主机名发送cookie。  
Path: 只为置顶path发送cookie  
Secure: 只有在HTTP使用SSL安全连接时才会发送cookie，例如：  
```txt  
Set-Cookie: private_id=519; secure
```





